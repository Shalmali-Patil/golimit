<html>
<head>
    <title>Shield</title>
    <link type="text/css" rel="stylesheet" href="ui/lib/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="ui/lib/jsgrid-theme.min.css" />
    <script type="text/javascript" src="ui/lib/jquery.min.js"></script>
    <script type="text/javascript" src="ui/lib/jquery-ui.min.js"></script>
    <script type="text/javascript" src="ui/lib/jsgrid.min.js"></script>


 
    <style>
        .shield {
            background-image: url('ui/lib/background.jpg');
             background-size: cover;
             background-repeat: no-repeat;
             background-position: center;
        }

        .shield::before {
            content: "";
            position: absolute;
            top: 0px;
            right: 0px;
            bottom: 0px;
            left: 0px;
            background-color: rgba(0,0,0,0.25);
        }

        .topcorner{
            position:absolute;
            top:50px;
            right: 50px;
        }
    </style>
    <script>
    
    

        $("document").ready(function() {

            //$("#logo").effect("bounce", "slow", {times: 50, distance: 500}, 500);

            setInterval(function() {
               // $('#flashes').effect('bounce',1000)
                $("#logo").effect("bounce", "slow", {times: 50, distance: 500}, 500);

            }, 1000);

            $("#jsGrid").jsGrid({
            width: "100%",
            height: "100%",
     
           inserting: true ,
            editing: true,
            sorting: true,
            paging: true,
            autoload: true,
            selecting: true,
            heading: true,
            deleteButton : false,
            filtering: false,
     
            loadIndicator: {
                show: function() {
                    console.log("loading started");
                },
                hide: function() {
                    console.log("loading finished");
                }
            },
            controller : {
                loadData:   function() {
                    var d = $.Deferred();
                   
                    $.ajax({
                        url: "/rateall",
                        dataType: "json"
                    }).done(function(response) {
                        console.log(response.b)
                        data = []
                        Object.keys(response).forEach(function(key){  
                            response[key]["Key"] = key ;
                            response[key]["Path"] = key.split("^")[0];
                            if (key.split("^")[1]    != null) {
                                response[key]["RateLimitKey"] = key.split("^")[1].split("|")[0];
                                response[key]["Value"] = key.split("^")[1].split("|")[1];
                            }
                            console.log(response[key]);
                            data.push(response[key]);
                        })
                        d.resolve(data);    
                    });
    
                    return d.promise();
                },

                insertItem: function(item) {
                    //alert("inserting")
                    // translator^site.publisher.id|*
                    item.Key = item.Path + "^" + item.RateLimitKey + "|" + item.Value
                    console.log("Inserting " + item);
                    return $.ajax({
                        type: "POST",
                        url: "/rate",
                        contentType: "text/json",
                        headers: {"apisecret" : "alpha"},
                        data: JSON.stringify(item),
                        error: function(err) {
                            alert(err.responseText);
                        }
                    });
                },
                
                updateItem: function(item) {
                    console.log("Updating " + item);
                    return $.ajax({
                        type: "PUT",
                        url: "/rate",
                        contentType: "text/json",
                        headers: {"apisecret" : "alpha"},
                        data: JSON.stringify(item)
                    });
                }
            },
            //data: clients,    
           

            fields: [
               // { name :"Key", type:"text", readOnly: true},
                { name :"Path", type:"text", inserting: true, editing: false, validate: "required" },
                { name :"RateLimitKey", type:"text", inserting: true, editing: false, validate: "required"   },
                { name :"Value", type:"text", inserting: true , editing: false, validate: "required" },
                { name: "Window", type: "number", width: 50, validate: "required" },
                { name: "Limit", type: "number", width: 100 },
                { name: "PeakAveraged", type: "text", width: 50 },
                //{ name: "Keys", type: "text"  },
                { name: "AllKeys", type: "textarea" ,width: 200 , cellRenderer: function(value, item) {
                    return "<td>" + String(value).replace(/,/g, '\n')+ "</td>";
                }},
                { name: "DefaultResponse", type: "textarea" ,width: 200 , cellRenderer: function(value, item) {
                    return "<td>" + String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') + "</td>";
                }},
                { name: "DefaultHeaders", type: "text"},
                { type: "control"

                    // modeSwitchButton: false,
                    // editButton: false,
                    // headerTemplate: function() {
                    //     return $("<button>").attr("type", "button").text("Add")
                    //             .on("click", function () {
            
                    //                 showDetailsDialog("Add", {});
                    //             });
                    // }   
                }
            ]
        });

    

      

        });
     
       
    </script>
</head>
<body class="shield">
    
    <div id="logo" class="topcorner" ><img src="ui/lib/schield-logo.jpg" width="150px" height="100px"/></div>
    <div id="jsGrid" class="divcenter" style="opacity: 100%; top: 40%;position: fixed;"></div>
    <div id="detailsDialog" class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-draggable ui-resizable"></div>
</body>

</html>